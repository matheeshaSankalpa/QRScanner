<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aesthetic Association Scanner</title>
    <!-- 1. Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. FIXED: Load the QR code scanner library in the <head> -->
    <!-- This makes sure it is loaded before the script in the body runs -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* Simple style for the scanner video */
        #qr-reader video {
            width: 100%;
            border-radius: 0.5rem; /* rounded corners */
        }
        /* Style for the scan region line */
        #qr-reader_scan_region > span > v {
            display: none; /* Hide the vertical lines */
        }
    </style>
</head>
<body class="bg-yellow-50 font-sans p-4 md:p-8 min-h-screen">

    <!-- Main card with white background and shadow -->
    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">

        <!-- Header with club name -->
        <h1 class="text-4xl font-bold text-center text-yellow-600 mb-8">
            Aesthetic Association
        </h1>

        <!-- 3. This div is where the scanner will be shown -->
        <div id="qr-reader" class="w-full max-w-sm mx-auto border-4 border-yellow-200 rounded-lg overflow-hidden mb-6">
            <!-- The scanner UI will be put here by the script -->
        </div>

        <!-- 4. This div will show the result of the last scan -->
        <div id="scan-result" class="text-center min-h-[50px]">
            <p class="text-gray-500">Waiting for scan...</p>
        </div>

        <!-- 5. This div will show the history of all scans from the database -->
        <div class="mt-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Scan History</h2>
            <div id="scan-history" class="space-y-3 max-h-96 overflow-y-auto bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <p class="text-gray-400 text-center" id="history-loading">Loading history from database...</p>
                <!-- Scan history items will be added here by the script -->
            </div>
        </div>

    </div>

    <!-- 6. Load Firebase libraries and run all app logic -->
    <!-- This script is at the end of the body, so all HTML elements exist -->
    <script type="module">
        // Import all the Firebase tools we need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // We need AUTH to sign in
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // We need FIRESTORE to save and read data
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase and App Setup ---

        // --- 1. YOUR Firebase Configuration ---
        const firebaseConfig = {
           apiKey: "AIzaSyAqrkTmpM7PMCdEf-7rNrrZNz88TNJWpzk",
           authDomain: "qrscaner-d9d97.firebaseapp.com",
           projectId: "qrscaner-d9d97",
           storageBucket: "qrscaner-d9d97.firebasestorage.app",
           messagingSenderId: "318319992628",
           appId: "1:318319992628:web:4cca7bae19905b81a20f61",
           measurementId: "G-GQVE1XRMBW"
        };
        // ------------------------------------------

        // Show more logs in the console to help debug
        setLogLevel('Debug');

        let db, auth, userId, scansCollectionRef;

        // UI Elements
        const scanResultEl = document.getElementById('scan-result');
        const scanHistoryEl = document.getElementById('scan-history');
        const historyLoadingEl = document.getElementById('history-loading');

        // This is the main function that runs everything
        async function main() {
            // Check if the QR scanner library loaded
            if (typeof Html5QrcodeScanner === "undefined") {
                console.error("Html5QrcodeScanner library is NOT loaded.");
                scanResultEl.innerHTML = `<p class="text-red-500 font-semibold">Error: QR Scanner library did not load. Check internet.</p>`;
                return;
            }

            try {
                // 1. Initialize Firebase
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 2. Sign in the user
                await signIn();

                // 3. Set up the database path
                // This will create a collection named "aesthetic_association_scans"
                scansCollectionRef = collection(db, "aesthetic_association_scans");
                console.log(`Database path: aesthetic_association_scans`);

                // 4. Start the QR code scanner
                startScanner();

                // 5. Listen for database changes and show history
                listenToScanHistory();

            } catch (error) {
                console.error("Error starting the app:", error);
                scanResultEl.innerHTML = `<p class="text-red-500 font-semibold">Error starting app. Check console.</p>`;
            }
        }

        // Function to sign in the user
        async function signIn() {
            return new Promise((resolve, reject) => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log(`User signed in: ${userId}`);
                        resolve(user);
                    } else {
                       // Try to sign in anonymously if no user
                       try {
                           const userCredential = await signInAnonymously(auth);
                           userId = userCredential.user.uid;
                           console.log(`User signed in anonymously: ${userId}`);
                           resolve(userCredential.user);
                       } catch (error) {
                           console.error("Error signing in anonymously:", error);
                           reject(error);
                       }
                    }
                });
            });
        }

        // Function to start the QR code scanner
        function startScanner() {
            // This object makes the scanner UI
            const html5QrCodeScanner = new Html5QrcodeScanner(
                "qr-reader", // The ID of the div to put the scanner in
                { 
                    fps: 10, // Frames per second
                    qrbox: { width: 250, height: 250 } // The size of the scan box
                },
                false // verbose - false means less console logs
            );
            
            // Start scanning. This calls 'onScanSuccess' when it finds a QR code
            html5QrCodeScanner.render(onScanSuccess);
        }

        // This function is called when a QR code is scanned
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan successful: ${decodedText}`);

            // 1. Show the result on the screen
            scanResultEl.innerHTML = `
                <p class="text-green-600 font-semibold text-lg">Scan Success!</p>
                <p class="text-gray-800 text-xl break-words p-2 bg-yellow-100 rounded-md">
                    ${escapeHTML(decodedText)}
                </p>
            `;

            // 2. Save the result to the database
            saveScanToDb(decodedText);
        }

        // This function saves the scanned text to the Firestore database
        async function saveScanToDb(scannedData) {
            if (!db) {
                console.error("Database not ready!");
                return;
            }

            try {
                // Create a new document in our collection
                const docRef = await addDoc(scansCollectionRef, {
                    scannedData: scannedData,         // The text from the QR code
                    scannedAt: Timestamp.now()      // The time of the scan
                });
                console.log("Scan saved to database with ID: ", docRef.id);
            } catch (error) {
                console.error("Error saving scan to database: ", error);
                scanResultEl.innerHTML += `<p class="text-red-500">Error saving to database.</p>`;
            }
        }

        // This function listens for real-time changes in the database history
        function listenToScanHistory() {
            if (!db) {
                console.error("Database not ready for history!");
                return;
            }

            // onSnapshot runs every time the data changes in Firestore
            onSnapshot(scansCollectionRef, (querySnapshot) => {
                const scans = [];
                // This line was fixed in the last update
                querySnapshot.forEach((doc) => {
                    scans.push({ id: doc.id, ...doc.data() });
                });

                // Sort scans in JavaScript to show newest first
                scans.sort((a, b) => b.scannedAt.toMillis() - a.scannedAt.toMillis());

                // Update the HTML to show the history
                updateHistoryUI(scans);

            }, (error) => {
                console.error("Error getting scan history: ", error);
                scanHistoryEl.innerHTML = `<p class="text-red-500">Error loading history.</p>`;
            });
        }

        // This function updates the HTML list of past scans
        function updateHistoryUI(scans) {
            // Clear old history
            scanHistoryEl.innerHTML = ''; 

            if (scans.length === 0) {
                // Show message if no scans yet
                historyLoadingEl.style.display = 'none'; // Hide loading message
                scanHistoryEl.innerHTML = `<p class="text-gray-400 text-center">No scans yet.</p>`;
                return;
            }
            
            historyLoadingEl.style.display = 'none'; // Hide loading message

            // Add each scan to the list
            scans.forEach(scan => {
                const scanItem = document.createElement('div');
                scanItem.className = 'border-b border-yellow-200 pb-2';

                // Format the time to be readable
                const scanTime = scan.scannedAt.toDate().toLocaleString();

                scanItem.innerHTML = `
                    <p class="font-medium text-gray-700 break-words">${escapeHTML(scan.scannedData)}</p>
                    <p class="text-sm text-gray-500">${scanTime}</p>
                `;
                scanHistoryEl.appendChild(scanItem);
            });
        }

        // Helper function to prevent XSS attacks (just good practice)
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }

        // Start the application
        main();

    </script>
</body>
</html>
